{% extends "base.html" %}

{% block content %}
<section class="space-y-6" dir="rtl">

  <header class="flex items-center justify-between">
    <h1 class="text-lg font-bold">📜 لیست معاملات و دارایی‌ها</h1>
    <a href="/" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700">بازگشت به داشبورد</a>
  </header>

  <!-- فرم افزودن معامله -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <h2 class="text-base font-semibold mb-3">افزودن معامله</h2>
    <form id="trade-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
      <input type="text" id="symbol" placeholder="نماد (مثلاً BTCUSDT)"
             class="md:col-span-2 w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <select id="side" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
        <option value="BUY">خرید</option>
        <option value="SELL">فروش</option>
      </select>
      <input type="number" step="0.00000001" id="qty" placeholder="مقدار"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="number" step="0.00000001" id="price" placeholder="قیمت واحد"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="number" step="0.00000001" id="fee" placeholder="کارمزد (اختیاری)"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="text" id="note" placeholder="توضیح (اختیاری)"
             class="md:col-span-2 w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <button type="submit"
              class="md:col-span-1 w-full bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-800 text-white rounded-lg px-4 py-2">
        افزودن
      </button>
      <p id="trade-status" class="md:col-span-3 text-sm mt-1 hidden"></p>
    </form>
  </section>

  <!-- خلاصه پوزیشن‌ها -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base font-semibold">خلاصه پوزیشن‌ها</h2>
      <span id="pos-count" class="text-xs text-gray-500"></span>
    </div>

    <div class="overflow-x-auto -mx-2">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-right bg-gray-100 dark:bg-gray-900">
            <th class="px-3 py-2">نماد</th>
            <th class="px-3 py-2">تعداد خالص</th>
            <th class="px-3 py-2">میانگین خرید</th>
            <th class="px-3 py-2">سرمایه‌گذاری</th>
            <th class="px-3 py-2">کارمزدها</th>
            <th class="px-3 py-2">جریان نقد محقق‌شده</th>
          </tr>
        </thead>
        <tbody id="positions-body"></tbody>
      </table>
    </div>
  </section>

  <!-- لیست معاملات -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base font-semibold">معاملات ثبت‌شده</h2>
      <span id="trade-count" class="text-xs text-gray-500"></span>
    </div>

    <div class="overflow-x-auto -mx-2">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-right bg-gray-100 dark:bg-gray-900">
            <th class="px-3 py-2">زمان</th>
            <th class="px-3 py-2">نماد</th>
            <th class="px-3 py-2">نوع</th>
            <th class="px-3 py-2">مقدار</th>
            <th class="px-3 py-2">قیمت</th>
            <th class="px-3 py-2">کارمزد</th>
            <th class="px-3 py-2">توضیح</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody id="trades-body"></tbody>
      </table>
    </div>
  </section>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (s) => document.querySelector(s);
  const tradesBody = $("#trades-body");
  const positionsBody = $("#positions-body");
  const tradeCount = $("#trade-count");
  const posCount = $("#pos-count");
  const statusMsg = $("#trade-status");

  function nf(num, digits=8) {
    if (num === null || num === undefined || isNaN(num)) return "-";
    // برای اعداد خیلی کوچک/بزرگ، نمایش علمی را کنترل می‌کنیم:
    const abs = Math.abs(num);
    if (abs !== 0 && (abs < 1e-6 || abs > 1e9)) {
      return num.toExponential(2);
    }
    // رقم اعشار را بر اساس بزرگی عدد تنظیم کن
    if (abs >= 1) digits = Math.min(digits, 4);
    return Number(num).toLocaleString("en-US", { maximumFractionDigits: digits });
  }

  function toastOk(msg){
    statusMsg.textContent = "✅ " + msg;
    statusMsg.className = "text-green-600 text-sm mt-1";
    statusMsg.classList.remove("hidden");
    setTimeout(() => statusMsg.classList.add("hidden"), 2000);
  }
  function toastErr(msg){
    statusMsg.textContent = "❌ " + msg;
    statusMsg.className = "text-red-600 text-sm mt-1";
    statusMsg.classList.remove("hidden");
  }

  function renderPositions(items=[]) {
    positionsBody.innerHTML = "";
    items.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2 font-semibold">${r.symbol}</td>
        <td class="px-3 py-2">${nf(r.net_qty)}</td>
        <td class="px-3 py-2">${nf(r.avg_buy_price)}</td>
        <td class="px-3 py-2">${nf(r.invested, 2)}</td>
        <td class="px-3 py-2">${nf(r.fees, 2)}</td>
        <td class="px-3 py-2">${nf(r.realized_cashflow, 2)}</td>
      `;
      positionsBody.appendChild(tr);
    });
    posCount.textContent = `${items.length} نماد`;
  }

  function renderTrades(items=[]) {
    tradesBody.innerHTML = "";
    items.forEach(t => {
      const tr = document.createElement("tr");
      const sideBadge = t.side === "BUY"
        ? `<span class="px-2 py-1 rounded-md text-xs bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">خرید</span>`
        : `<span class="px-2 py-1 rounded-md text-xs bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300">فروش</span>`;

      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${t.ts || "-"}</td>
        <td class="px-3 py-2 font-semibold">${(t.symbol || "").toUpperCase()}</td>
        <td class="px-3 py-2">${sideBadge}</td>
        <td class="px-3 py-2">${nf(t.qty)}</td>
        <td class="px-3 py-2">${nf(t.price)}</td>
        <td class="px-3 py-2">${nf(t.fee, 4)}</td>
        <td class="px-3 py-2">${t.note || "-"}</td>
        <td class="px-3 py-2 text-left">
          <button data-id="${t.id}" class="del-btn text-rose-600 hover:underline">حذف</button>
        </td>
      `;
      tradesBody.appendChild(tr);
    });
    tradeCount.textContent = `${items.length} رکورد`;
    // bind delete
    tradesBody.querySelectorAll(".del-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        if (!id) return;
        if (!confirm("این معامله حذف شود؟")) return;
        fetch(`/portfolio/api/trades/${id}`, { method: "DELETE" })
          .then(r => r.json())
          .then(res => {
            if (res.ok) {
              toastOk("حذف شد");
              loadAll();
            } else {
              toastErr("خطا در حذف");
            }
          })
          .catch(() => toastErr("خطای ارتباط"));
      });
    });
  }

  function loadAll() {
    fetch("/portfolio/api/trades")
      .then(r => r.json())
      .then(res => {
        if (!res.ok) return;
        renderTrades(res.items || []);
        renderPositions(res.positions || []);
      })
      .catch(() => toastErr("خطا در دریافت اطلاعات"));
  }

  // Submit form
  const form = document.getElementById("trade-form");
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const payload = {
      symbol: document.getElementById("symbol").value.trim(),
      side: document.getElementById("side").value,
      qty: parseFloat(document.getElementById("qty").value),
      price: parseFloat(document.getElementById("price").value),
      fee: parseFloat(document.getElementById("fee").value || "0"),
      note: document.getElementById("note").value.trim()
    };
    fetch("/portfolio/api/trades", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    })
      .then(r => r.json())
      .then(res => {
        if (res.ok) {
          toastOk("ثبت شد");
          form.reset();
          loadAll();
        } else {
          toastErr("ورودی نامعتبر");
        }
      })
      .catch(() => toastErr("خطای ارتباط"));
  });

  loadAll();
});
</script>
{% endblock %}
