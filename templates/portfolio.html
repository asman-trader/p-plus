{% extends "base.html" %}

{% block content %}
<section class="space-y-6" dir="rtl">

  <header class="flex items-center justify-between">
    <h1 class="text-lg font-bold">ğŸ“œ Ù„ÛŒØ³Øª Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ùˆ Ø¯Ø§Ø±Ø§ÛŒÛŒâ€ŒÙ‡Ø§</h1>
    <a href="/" class="text-sm bg-blue-600 text-white px-3 py-1.5 rounded-lg hover:bg-blue-700">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
  </header>

  <!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡ -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <h2 class="text-base font-semibold mb-3">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø¹Ø§Ù…Ù„Ù‡</h2>
    <form id="trade-form" class="grid grid-cols-1 md:grid-cols-6 gap-3">
      <input type="text" id="symbol" placeholder="Ù†Ù…Ø§Ø¯ (Ù…Ø«Ù„Ø§Ù‹ BTCUSDT)"
             class="md:col-span-2 w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <select id="side" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
        <option value="BUY">Ø®Ø±ÛŒØ¯</option>
        <option value="SELL">ÙØ±ÙˆØ´</option>
      </select>
      <input type="number" step="0.00000001" id="qty" placeholder="Ù…Ù‚Ø¯Ø§Ø±"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="number" step="0.00000001" id="price" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="number" step="0.00000001" id="fee" placeholder="Ú©Ø§Ø±Ù…Ø²Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
             class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <input type="text" id="note" placeholder="ØªÙˆØ¶ÛŒØ­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
             class="md:col-span-2 w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 bg-white dark:bg-gray-900 outline-none">
      <button type="submit"
              class="md:col-span-1 w-full bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-800 text-white rounded-lg px-4 py-2">
        Ø§ÙØ²ÙˆØ¯Ù†
      </button>
      <p id="trade-status" class="md:col-span-3 text-sm mt-1 hidden"></p>
    </form>
  </section>

  <!-- Ø®Ù„Ø§ØµÙ‡ Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§ -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base font-semibold">Ø®Ù„Ø§ØµÙ‡ Ù¾ÙˆØ²ÛŒØ´Ù†â€ŒÙ‡Ø§</h2>
      <span id="pos-count" class="text-xs text-gray-500"></span>
    </div>

    <div class="overflow-x-auto -mx-2">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-right bg-gray-100 dark:bg-gray-900">
            <th class="px-3 py-2">Ù†Ù…Ø§Ø¯</th>
            <th class="px-3 py-2">ØªØ¹Ø¯Ø§Ø¯ Ø®Ø§Ù„Øµ</th>
            <th class="px-3 py-2">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯</th>
            <th class="px-3 py-2">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</th>
            <th class="px-3 py-2">Ú©Ø§Ø±Ù…Ø²Ø¯Ù‡Ø§</th>
            <th class="px-3 py-2">Ø¬Ø±ÛŒØ§Ù† Ù†Ù‚Ø¯ Ù…Ø­Ù‚Ù‚â€ŒØ´Ø¯Ù‡</th>
          </tr>
        </thead>
        <tbody id="positions-body"></tbody>
      </table>
    </div>
  </section>

  <!-- Ù„ÛŒØ³Øª Ù…Ø¹Ø§Ù…Ù„Ø§Øª -->
  <section class="card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base font-semibold">Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h2>
      <span id="trade-count" class="text-xs text-gray-500"></span>
    </div>

    <div class="overflow-x-auto -mx-2">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-right bg-gray-100 dark:bg-gray-900">
            <th class="px-3 py-2">Ø²Ù…Ø§Ù†</th>
            <th class="px-3 py-2">Ù†Ù…Ø§Ø¯</th>
            <th class="px-3 py-2">Ù†ÙˆØ¹</th>
            <th class="px-3 py-2">Ù…Ù‚Ø¯Ø§Ø±</th>
            <th class="px-3 py-2">Ù‚ÛŒÙ…Øª</th>
            <th class="px-3 py-2">Ú©Ø§Ø±Ù…Ø²Ø¯</th>
            <th class="px-3 py-2">ØªÙˆØ¶ÛŒØ­</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody id="trades-body"></tbody>
      </table>
    </div>
  </section>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (s) => document.querySelector(s);
  const tradesBody = $("#trades-body");
  const positionsBody = $("#positions-body");
  const tradeCount = $("#trade-count");
  const posCount = $("#pos-count");
  const statusMsg = $("#trade-status");

  function nf(num, digits=8) {
    if (num === null || num === undefined || isNaN(num)) return "-";
    // Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø¯Ø§Ø¯ Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú©/Ø¨Ø²Ø±Ú¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ù…ÛŒ Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…:
    const abs = Math.abs(num);
    if (abs !== 0 && (abs < 1e-6 || abs > 1e9)) {
      return num.toExponential(2);
    }
    // Ø±Ù‚Ù… Ø§Ø¹Ø´Ø§Ø± Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¨Ø²Ø±Ú¯ÛŒ Ø¹Ø¯Ø¯ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
    if (abs >= 1) digits = Math.min(digits, 4);
    return Number(num).toLocaleString("en-US", { maximumFractionDigits: digits });
  }

  function toastOk(msg){
    statusMsg.textContent = "âœ… " + msg;
    statusMsg.className = "text-green-600 text-sm mt-1";
    statusMsg.classList.remove("hidden");
    setTimeout(() => statusMsg.classList.add("hidden"), 2000);
  }
  function toastErr(msg){
    statusMsg.textContent = "âŒ " + msg;
    statusMsg.className = "text-red-600 text-sm mt-1";
    statusMsg.classList.remove("hidden");
  }

  function renderPositions(items=[]) {
    positionsBody.innerHTML = "";
    items.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-3 py-2 font-semibold">${r.symbol}</td>
        <td class="px-3 py-2">${nf(r.net_qty)}</td>
        <td class="px-3 py-2">${nf(r.avg_buy_price)}</td>
        <td class="px-3 py-2">${nf(r.invested, 2)}</td>
        <td class="px-3 py-2">${nf(r.fees, 2)}</td>
        <td class="px-3 py-2">${nf(r.realized_cashflow, 2)}</td>
      `;
      positionsBody.appendChild(tr);
    });
    posCount.textContent = `${items.length} Ù†Ù…Ø§Ø¯`;
  }

  function renderTrades(items=[]) {
    tradesBody.innerHTML = "";
    items.forEach(t => {
      const tr = document.createElement("tr");
      const sideBadge = t.side === "BUY"
        ? `<span class="px-2 py-1 rounded-md text-xs bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300">Ø®Ø±ÛŒØ¯</span>`
        : `<span class="px-2 py-1 rounded-md text-xs bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-300">ÙØ±ÙˆØ´</span>`;

      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${t.ts || "-"}</td>
        <td class="px-3 py-2 font-semibold">${(t.symbol || "").toUpperCase()}</td>
        <td class="px-3 py-2">${sideBadge}</td>
        <td class="px-3 py-2">${nf(t.qty)}</td>
        <td class="px-3 py-2">${nf(t.price)}</td>
        <td class="px-3 py-2">${nf(t.fee, 4)}</td>
        <td class="px-3 py-2">${t.note || "-"}</td>
        <td class="px-3 py-2 text-left">
          <button data-id="${t.id}" class="del-btn text-rose-600 hover:underline">Ø­Ø°Ù</button>
        </td>
      `;
      tradesBody.appendChild(tr);
    });
    tradeCount.textContent = `${items.length} Ø±Ú©ÙˆØ±Ø¯`;
    // bind delete
    tradesBody.querySelectorAll(".del-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        if (!id) return;
        if (!confirm("Ø§ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        fetch(`/portfolio/api/trades/${id}`, { method: "DELETE" })
          .then(r => r.json())
          .then(res => {
            if (res.ok) {
              toastOk("Ø­Ø°Ù Ø´Ø¯");
              loadAll();
            } else {
              toastErr("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù");
            }
          })
          .catch(() => toastErr("Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·"));
      });
    });
  }

  function loadAll() {
    fetch("/portfolio/api/trades")
      .then(r => r.json())
      .then(res => {
        if (!res.ok) return;
        renderTrades(res.items || []);
        renderPositions(res.positions || []);
      })
      .catch(() => toastErr("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª"));
  }

  // Submit form
  const form = document.getElementById("trade-form");
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const payload = {
      symbol: document.getElementById("symbol").value.trim(),
      side: document.getElementById("side").value,
      qty: parseFloat(document.getElementById("qty").value),
      price: parseFloat(document.getElementById("price").value),
      fee: parseFloat(document.getElementById("fee").value || "0"),
      note: document.getElementById("note").value.trim()
    };
    fetch("/portfolio/api/trades", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    })
      .then(r => r.json())
      .then(res => {
        if (res.ok) {
          toastOk("Ø«Ø¨Øª Ø´Ø¯");
          form.reset();
          loadAll();
        } else {
          toastErr("ÙˆØ±ÙˆØ¯ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø±");
        }
      })
      .catch(() => toastErr("Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·"));
  });

  loadAll();
});
</script>
{% endblock %}
