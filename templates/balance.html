{% extends "base.html" %}

{% block title %}Ø¯Ø§Ø±Ø§ÛŒÛŒ - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯{% endblock %}

{% block content %}
<div class="card" id="balance">
  <h2>Ø¯Ø§Ø±Ø§ÛŒÛŒ ÙØ¹Ù„ÛŒ</h2>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">ğŸª™</div>
      <div>
        <div class="label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ BTC</div>
        <div class="value">{{ '%.8f' % current_btc_balance }} <span class="sub">BTC</span></div>
        <div class="sub">Ø®Ø±ÛŒØ¯: {{ '%.8f' % total_purchased_btc }} | Ø¨Ø±Ø¯Ø§Ø´Øª: {{ '%.8f' % total_withdrawn_btc }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ’µ</div>
      <div>
        <div class="label">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (USD)</div>
        <div class="value"><span id="current_usd_value">...</span> <span class="sub">$</span></div>
        <div class="sub">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: ${{ '%.2f' % net_invested_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ‡®ğŸ‡·</div>
      <div>
        <div class="label">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (ØªÙˆÙ…Ø§Ù†)</div>
        <div class="value"><span id="current_toman_value">...</span> <span class="sub">ØªÙˆÙ…Ø§Ù†</span></div>
        <div class="sub">Ù†Ø±Ø®: {{ '{:,.0f}'.format(usd_to_toman) }} ØªÙˆÙ…Ø§Ù†</div>
      </div>
    </div>
  </div>
  
  <div class="divider"></div>
  
  <h3>Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">ğŸ“ˆ</div>
      <div>
        <div class="label">Ú©Ù„ Ø®Ø±ÛŒØ¯ (USD)</div>
        <div class="value">${{ '%.2f' % total_invested_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ“‰</div>
      <div>
        <div class="label">Ú©Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª (USD)</div>
        <div class="value">${{ '%.2f' % total_withdrawn_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">ğŸ’°</div>
      <div>
        <div class="label">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®Ø§Ù„Øµ</div>
        <div class="value">${{ '%.2f' % net_invested_usd }}</div>
      </div>
    </div>
  </div>
  
  <div class="hint">ğŸ’¡ Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ BTC Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¨Ø§Ø²Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
</div>

<script>
(function() {
  const btcAmount = {{ current_btc_balance }};
  const usdToToman = {{ usd_to_toman }};
  
  // Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ BTC (Ù…Ø«Ø§Ù„ - Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø¨Ø§ÛŒØ¯ Ø§Ø² API Ø¯Ø±ÛŒØ§ÙØª Ø´ÙˆØ¯)
  function fetchCurrentPrice() {
    // Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© API ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
    // Ø¨Ø±Ø§ÛŒ Ù…Ø«Ø§Ù„ Ø§Ø² CoinGecko ÛŒØ§ Binance
    return fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
      .then(response => response.json())
      .then(data => data.bitcoin.usd)
      .catch(() => 50000); // Ù‚ÛŒÙ…Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
  }
  
  function updateValues(currentPrice) {
    const usdValue = btcAmount * currentPrice;
    const tomanValue = usdValue * usdToToman;
    
    document.getElementById('current_usd_value').textContent = usdValue.toFixed(2);
    document.getElementById('current_toman_value').textContent = tomanValue.toLocaleString('fa-IR');
  }
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
  fetchCurrentPrice().then(updateValues);
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
  setInterval(() => {
    fetchCurrentPrice().then(updateValues);
  }, 30000);
})();
</script>
{% endblock %}
