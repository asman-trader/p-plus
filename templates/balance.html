{% extends "base.html" %}

{% block title %}دارایی - داشبورد{% endblock %}

{% block content %}
<div class="card" id="balance">
  <h2>دارایی فعلی</h2>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">🪙</div>
      <div>
        <div class="label">موجودی BTC</div>
        <div class="value">{{ '%.8f' % current_btc_balance }} <span class="sub">BTC</span></div>
        <div class="sub">خرید: {{ '%.8f' % total_purchased_btc }} | برداشت: {{ '%.8f' % total_withdrawn_btc }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">💵</div>
      <div>
        <div class="label">ارزش فعلی (USD)</div>
        <div class="value"><span id="current_usd_value">...</span> <span class="sub">$</span></div>
        <div class="sub">سرمایه‌گذاری: ${{ '%.2f' % net_invested_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">🇮🇷</div>
      <div>
        <div class="label">ارزش فعلی (تومان)</div>
        <div class="value"><span id="current_toman_value">...</span> <span class="sub">تومان</span></div>
        <div class="sub">نرخ: {{ '{:,.0f}'.format(usd_to_toman) }} تومان</div>
      </div>
    </div>
  </div>
  
  <div class="divider"></div>
  
  <h3>جزئیات تراکنش‌ها</h3>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">📈</div>
      <div>
        <div class="label">کل خرید (USD)</div>
        <div class="value">${{ '%.2f' % total_invested_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">📉</div>
      <div>
        <div class="label">کل برداشت (USD)</div>
        <div class="value">${{ '%.2f' % total_withdrawn_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">💰</div>
      <div>
        <div class="label">سرمایه‌گذاری خالص</div>
        <div class="value">${{ '%.2f' % net_invested_usd }}</div>
      </div>
    </div>
  </div>
  
  <div class="hint">💡 قیمت فعلی BTC به‌صورت خودکار از بازار دریافت می‌شود</div>
</div>

<script>
(function() {
  const btcAmount = {{ current_btc_balance }};
  const usdToToman = {{ usd_to_toman }};
  
  // دریافت قیمت فعلی BTC (مثال - در واقعیت باید از API دریافت شود)
  function fetchCurrentPrice() {
    // اینجا باید از یک API واقعی استفاده شود
    // برای مثال از CoinGecko یا Binance
    return fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd')
      .then(response => response.json())
      .then(data => data.bitcoin.usd)
      .catch(() => 50000); // قیمت پیش‌فرض در صورت خطا
  }
  
  function updateValues(currentPrice) {
    const usdValue = btcAmount * currentPrice;
    const tomanValue = usdValue * usdToToman;
    
    document.getElementById('current_usd_value').textContent = usdValue.toFixed(2);
    document.getElementById('current_toman_value').textContent = tomanValue.toLocaleString('fa-IR');
  }
  
  // بارگذاری اولیه
  fetchCurrentPrice().then(updateValues);
  
  // به‌روزرسانی هر 30 ثانیه
  setInterval(() => {
    fetchCurrentPrice().then(updateValues);
  }, 30000);
})();
</script>
{% endblock %}
