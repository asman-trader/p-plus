{% extends "base.html" %}

{% block title %}دارایی - داشبورد{% endblock %}

{% block content %}
<div class="card" id="balance">
  <h2>دارایی فعلی</h2>
  
  <!-- هشدار موجودی منفی -->
  {% if current_btc_balance < 0 %}
  <div class="flash error" style="margin-bottom: 16px;">
    ⚠️ هشدار: موجودی BTC منفی است! ({{ '%.8f' % current_btc_balance }} BTC)
  </div>
  {% endif %}
  
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">🪙</div>
      <div>
        <div class="label">موجودی BTC</div>
        <div class="value">{{ '%.8f' % current_btc_balance }} <span class="sub">BTC</span></div>
        <div class="sub">خرید: {{ '%.8f' % total_purchased_btc }} | برداشت: {{ '%.8f' % total_withdrawn_btc }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">💵</div>
      <div>
        <div class="label">ارزش فعلی (USD)</div>
        <div class="value"><span id="current_usd_value">...</span> <span class="sub">$</span></div>
        <div class="sub">سرمایه‌گذاری: ${{ '%.2f' % net_invested_usd }}</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">🇮🇷</div>
      <div>
        <div class="label">ارزش فعلی (تومان)</div>
        <div class="value"><span id="current_toman_value">...</span> <span class="sub">تومان</span></div>
        <div class="sub">نرخ: {{ '{:,.0f}'.format(usd_to_toman) }} تومان</div>
      </div>
    </div>
  </div>
  
  <div class="divider"></div>
  
  <h3>عملکرد سرمایه‌گذاری</h3>
  <div class="kpi-grid">
    <div class="kpi {% if profit_loss_usd >= 0 %}positive{% else %}negative{% endif %}">
      <div class="icon">📊</div>
      <div>
        <div class="label">سود / زیان</div>
        <div class="value" id="profit_loss_value">${{ '%.2f' % profit_loss_usd }}</div>
        <div class="sub" id="profit_loss_toman">{{ '{:,.0f}'.format(profit_loss_usd * usd_to_toman) }} تومان</div>
      </div>
    </div>
    <div class="kpi {% if roi_percentage >= 0 %}positive{% else %}negative{% endif %}">
      <div class="icon">📈</div>
      <div>
        <div class="label">بازده (ROI)</div>
        <div class="value" id="roi_value">{{ '%.1f' % roi_percentage }}%</div>
        <div class="sub">نسبت به سرمایه خالص</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">⏰</div>
      <div>
        <div class="label">مدت سرمایه‌گذاری</div>
        <div class="value">{{ inception_days }} <span class="sub">روز</span></div>
        <div class="sub">از شروع فعالیت</div>
      </div>
    </div>
  </div>
  
  <div class="divider"></div>
  
  <h3>جزئیات تراکنش‌ها</h3>
  <div class="kpi-grid">
    <div class="kpi">
      <div class="icon">📈</div>
      <div>
        <div class="label">کل خرید (USD)</div>
        <div class="value">${{ '%.2f' % total_invested_usd }}</div>
        <div class="sub">{{ total_purchases_count }} تراکنش</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">📉</div>
      <div>
        <div class="label">کل برداشت (USD)</div>
        <div class="value">${{ '%.2f' % total_withdrawn_usd }}</div>
        <div class="sub">{{ total_withdrawals_count }} تراکنش</div>
      </div>
    </div>
    <div class="kpi">
      <div class="icon">💰</div>
      <div>
        <div class="label">سرمایه‌گذاری خالص</div>
        <div class="value">${{ '%.2f' % net_invested_usd }}</div>
        <div class="sub">آخرین تراکنش: {{ last_transaction_date or 'هیچ' }}</div>
      </div>
    </div>
  </div>
  
  <div class="hint">💡 قیمت فعلی BTC به‌صورت خودکار از بازار دریافت می‌شود</div>
</div>

<div class="card" id="trades">
  <h2>معاملات</h2>
  <div class="row" id="trades_desktop">
    <div class="col">
      <h3 style="margin-bottom:8px;">باز</h3>
      <div class="table-scroll">
        <table class="responsive">
          <thead>
            <tr>
              <th>#</th>
              <th>تاریخ</th>
              <th>BTC باقیمانده</th>
              <th>میانگین قیمت (USD)</th>
              <th>ارزش فعلی</th>
              <th>سود/زیان</th>
            </tr>
          </thead>
          <tbody id="open_trades_body">
          </tbody>
        </table>
      </div>
    </div>
    <div class="col">
      <h3 style="margin-bottom:8px;">بسته</h3>
      <div class="table-scroll">
        <table class="responsive">
          <thead>
            <tr>
              <th>#</th>
              <th>خرید</th>
              <th>خروج</th>
              <th>BTC</th>
              <th>میانگین خرید</th>
              <th>میانگین خروج</th>
              <th>سود/زیان</th>
            </tr>
          </thead>
          <tbody id="closed_trades_body">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="trades_mobile" style="display:none;">
    <h3 style="margin-bottom:8px;">باز</h3>
    <div id="open_cards" class="row"></div>
    <div class="divider"></div>
    <h3 style="margin-bottom:8px;">بسته</h3>
    <div id="closed_cards" class="row"></div>
  </div>
</div>

<script>
(function() {
  const btcAmount = {{ current_btc_balance }};
  let usdToToman = {{ usd_to_toman }};  // Initial from server
  const netInvestedUsd = {{ net_invested_usd }};
  
  // دریافت قیمت‌ها
  function fetchCurrentPrice() {
    return fetch('/api/price')
      .then(response => response.json())
      .then(data => {
        usdToToman = data.usdt_irt || usdToToman;  // Update toman rate
        return data.btc_usdt;
      })
      .catch(() => 50000);
  }
  
  function updateValues(currentPrice) {
    const usdValue = btcAmount * currentPrice;
    const tomanValue = usdValue * usdToToman;
    
    // به‌روزرسانی ارزش فعلی
    document.getElementById('current_usd_value').textContent = usdValue.toFixed(2);
    document.getElementById('current_toman_value').textContent = tomanValue.toLocaleString('fa-IR');
    
    // محاسبه و به‌روزرسانی سود/زیان
    const profitLoss = usdValue - netInvestedUsd;
    const profitLossToman = profitLoss * usdToToman;
    
    document.getElementById('profit_loss_value').textContent = '$' + profitLoss.toFixed(2);
    document.getElementById('profit_loss_toman').textContent = profitLossToman.toLocaleString('fa-IR') + ' تومان';
    
    // محاسبه و به‌روزرسانی ROI
    let roiPercentage = 0;
    if (netInvestedUsd > 0) {
      roiPercentage = (profitLoss / netInvestedUsd) * 100;
    }
    document.getElementById('roi_value').textContent = roiPercentage.toFixed(1) + '%';
    
    // تغییر رنگ KPI ها بر اساس سود/زیان
    const profitLossKpi = document.querySelector('.kpi.positive, .kpi.negative');
    if (profitLossKpi) {
      profitLossKpi.classList.remove('positive', 'negative');
      profitLossKpi.classList.add(profitLoss >= 0 ? 'positive' : 'negative');
    }
    
    const roiKpi = document.querySelector('.kpi.positive, .kpi.negative');
    if (roiKpi && roiKpi !== profitLossKpi) {
      roiKpi.classList.remove('positive', 'negative');
      roiKpi.classList.add(roiPercentage >= 0 ? 'positive' : 'negative');
    }
  }
  
  // بارگذاری اولیه
  fetchCurrentPrice().then(updateValues);
  
  // به‌روزرسانی هر 30 ثانیه
  setInterval(() => {
    fetchCurrentPrice().then(updateValues);
  }, 30000);
})();
</script>

<script>
  (function(){
    var purchases = {{ purchases|tojson }};
    var withdrawals = {{ withdrawals|tojson }};
    var openBody = document.getElementById('open_trades_body');
    var closedBody = document.getElementById('closed_trades_body');
    var usdToToman = {{ usd_to_toman }};
    var priceEl = document.getElementById('btc_usd');

    function toNum(x){ return typeof x === 'number' ? x : Number(x); }

    // FIFO match
    var queue = purchases.map(function(p){
      return { id:p.id, date:p.created_at, amount: toNum(p.amount_btc), price: toNum(p.price_usd_per_btc) };
    }).reverse(); // oldest first
    var closedLots = [];
    withdrawals.slice().forEach(function(w){
      var remain = toNum(w.amount_btc);
      var wPrice = toNum(w.price_usd_per_btc);
      while(remain > 1e-12 && queue.length){
        var lot = queue[0];
        var take = Math.min(remain, lot.amount);
        // record closed trade row
        var buyCost = take * lot.price;
        var sellVal = take * wPrice;
        var pl = sellVal - buyCost;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td data-label="#">'+lot.id+'</td>'+
                       '<td data-label="خرید">'+lot.date+'</td>'+
                       '<td data-label="خروج">'+w.created_at+'</td>'+
                       '<td data-label="BTC">'+take.toFixed(8)+'</td>'+
                       '<td data-label="میانگین خرید">'+lot.price.toFixed(2)+'</td>'+
                       '<td data-label="میانگین خروج">'+wPrice.toFixed(2)+'</td>'+
                       '<td data-label="سود/زیان">'+pl.toFixed(2)+' $</td>';
        closedBody.appendChild(tr);
        closedLots.push({ id: lot.id, buy: lot.date, sell: w.created_at, btc: take, buyP: lot.price, sellP: wPrice, pl: pl });
        lot.amount -= take;
        remain -= take;
        if(lot.amount <= 1e-12) queue.shift();
      }
    });

    function renderOpen(currentPrice){
      openBody.innerHTML='';
      var openCards = document.getElementById('open_cards');
      if (openCards) openCards.innerHTML='';
      queue.forEach(function(lot){
        var cost = lot.amount * lot.price;
        var curVal = lot.amount * currentPrice;
        var pl = curVal - cost;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td data-label="#">'+lot.id+'</td>'+
                       '<td data-label="تاریخ">'+lot.date+'</td>'+
                       '<td data-label="BTC باقیمانده">'+lot.amount.toFixed(8)+'</td>'+
                       '<td data-label="میانگین قیمت (USD)">'+lot.price.toFixed(2)+'</td>'+
                       '<td data-label="ارزش فعلی">'+curVal.toFixed(2)+' $</td>'+
                       '<td data-label="سود/زیان">'+pl.toFixed(2)+' $</td>';
        openBody.appendChild(tr);
        if (openCards) {
          var cost = lot.amount * lot.price;
          var curVal = lot.amount * currentPrice;
          var pl = curVal - cost;
          var card = document.createElement('div');
          card.className = 'card col';
          card.innerHTML = '<div class="kpi">'+
            '<div class="icon">📈</div>'+
            '<div>'+
            '<div class="label">#'+lot.id+' • '+lot.date+'</div>'+
            '<div class="value">'+lot.amount.toFixed(8)+' <span class="sub">BTC</span></div>'+
            '<div class="sub">میانگین: '+lot.price.toFixed(2)+' $</div>'+
            '<div class="label" style="margin-top:8px;">ارزش فعلی: '+curVal.toFixed(2)+' $ • سود/زیان: '+pl.toFixed(2)+' $</div>'+
            '</div></div>';
          openCards.appendChild(card);
        }
      });
    }

    function renderClosedCards(){
      var closedCards = document.getElementById('closed_cards');
      if (!closedCards) return;
      closedCards.innerHTML = '';
      closedLots.forEach(function(r){
        var card = document.createElement('div');
        card.className = 'card col';
        card.innerHTML = '<div class="kpi">'+
          '<div class="icon">📉</div>'+
          '<div>'+
          '<div class="label">#'+r.id+' • '+r.buy+' → '+r.sell+'</div>'+
          '<div class="value">'+r.btc.toFixed(8)+' <span class="sub">BTC</span></div>'+
          '<div class="sub">میانگین خرید: '+r.buyP.toFixed(2)+' $ • میانگین خروج: '+r.sellP.toFixed(2)+' $</div>'+
          '<div class="label" style="margin-top:8px;">سود/زیان: '+r.pl.toFixed(2)+' $</div>'+
          '</div></div>';
        closedCards.appendChild(card);
      });
    }
    renderClosedCards();

    function readPrice(){
      var p = Number(priceEl && priceEl.textContent && priceEl.textContent.replace(/[^0-9.]/g,''));
      if (!isFinite(p) || p<=0) return null;
      return p;
    }

    var initial = readPrice();
    if (initial) renderOpen(initial);
    var obs = new MutationObserver(function(){
      var p = readPrice();
      if (p) renderOpen(p);
    });
    if (priceEl) obs.observe(priceEl, { childList:true });

    function applyResponsive(){
      var isMobile = window.matchMedia('(max-width: 640px)').matches;
      var d = document.getElementById('trades_desktop');
      var m = document.getElementById('trades_mobile');
      if (d && m) {
        d.style.display = isMobile ? 'none' : '';
        m.style.display = isMobile ? '' : 'none';
      }
    }
    applyResponsive();
    window.addEventListener('resize', applyResponsive);
  })();
</script>
{% endblock %}
