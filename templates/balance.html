{% extends "base.html" %}

{% block title %}Ø¯Ø§Ø±Ø§ÛŒÛŒ - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯{% endblock %}

{% block content %}
  <style>
    /* Enhanced Balance Page Styles */
    .page-header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .page-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="balancePattern" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23balancePattern)"/></svg>');
      opacity: 0.3;
    }
    
    .page-content {
      position: relative;
      z-index: 1;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .page-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 24px 0;
    }
    
    .balance-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .balance-card {
      text-align: center;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .balance-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .balance-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Alert Styles */
    .alert-container {
      margin-bottom: 24px;
    }
    
    .alert {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-radius: 16px;
      padding: 16px 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);
    }
    
    .alert-icon {
      font-size: 20px;
    }
    
    .alert-text {
      font-weight: 600;
    }
    
    /* Enhanced KPI Cards */
    .kpi-section {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .kpi-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
    }
    
    .kpi-section-title {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 20px 0;
      color: var(--text);
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    @media (min-width: 640px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (min-width: 1024px) {
      .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    .kpi-card {
      background: var(--pill-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .kpi-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .kpi-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
    }
    
    .kpi-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      margin: 0;
    }
    
    .kpi-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text);
      margin: 0 0 4px 0;
      line-height: 1;
    }
    
    .kpi-subtitle {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }
    
    .kpi-card.positive .kpi-value {
      color: #10b981;
    }
    
    .kpi-card.negative .kpi-value {
      color: #ef4444;
    }
    
    /* Info Card */
    .info-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .info-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }
    
    .info-text {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }
    
    /* Responsive Design */
    @media (max-width: 640px) {
      .page-header {
        padding: 24px 20px;
        margin-bottom: 16px;
      }
      
      .page-title {
        font-size: 24px;
      }
      
      .balance-overview {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .balance-card {
        padding: 16px;
      }
      
      .balance-value {
        font-size: 20px;
      }
      
      .kpi-section {
        padding: 20px;
      }
      
      .kpi-section-title {
        font-size: 18px;
      }
      
      .kpi-card {
        padding: 16px;
      }
      
      .kpi-value {
        font-size: 20px;
      }
    }
  </style>

  <!-- Page Header -->
  <div class="page-header">
    <div class="page-content">
      <h1 class="page-title">ğŸ’ Ø¯Ø§Ø±Ø§ÛŒÛŒ ÙØ¹Ù„ÛŒ</h1>
      <p class="page-subtitle">Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ù…Ù„ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾ÙˆØ±ØªÙÙˆÙ„ÛŒÙˆ</p>
      
      <div class="balance-overview">
        <div class="balance-card">
          <div class="balance-value">{{ '%.8f' % current_btc_balance }}</div>
          <div class="balance-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ BTC</div>
        </div>
        <div class="balance-card">
          <div class="balance-value" id="current_usd_value">...</div>
          <div class="balance-label">Ø§Ø±Ø²Ø´ USD</div>
        </div>
        <div class="balance-card">
          <div class="balance-value" id="current_toman_value">...</div>
          <div class="balance-label">Ø§Ø±Ø²Ø´ ØªÙˆÙ…Ø§Ù†</div>
        </div>
        <div class="balance-card">
          <div class="balance-value" id="profit_loss_value">${{ '%.2f' % profit_loss_usd }}</div>
          <div class="balance-label">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert for Negative Balance -->
  {% if current_btc_balance < 0 %}
  <div class="alert-container">
    <div class="alert">
      <div class="alert-icon">âš ï¸</div>
      <div class="alert-text">Ù‡Ø´Ø¯Ø§Ø±: Ù…ÙˆØ¬ÙˆØ¯ÛŒ BTC Ù…Ù†ÙÛŒ Ø§Ø³Øª! ({{ '%.8f' % current_btc_balance }} BTC)</div>
    </div>
  </div>
  {% endif %}

  <!-- Current Holdings -->
  <div class="kpi-section">
    <h2 class="kpi-section-title">ğŸª™ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸª™</div>
          <div>
            <h3 class="kpi-title">Ù…ÙˆØ¬ÙˆØ¯ÛŒ BTC</h3>
          </div>
        </div>
        <div class="kpi-value">{{ '%.8f' % current_btc_balance }} <span style="font-size: 16px; color: var(--muted);">BTC</span></div>
        <p class="kpi-subtitle">Ø®Ø±ÛŒØ¯: {{ '%.8f' % total_purchased_btc }} | Ø¨Ø±Ø¯Ø§Ø´Øª: {{ '%.8f' % total_withdrawn_btc }}</p>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ’µ</div>
          <div>
            <h3 class="kpi-title">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (USD)</h3>
          </div>
        </div>
        <div class="kpi-value" id="current_usd_value_detail">...</div>
        <p class="kpi-subtitle">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ: ${{ '%.2f' % net_invested_usd }}</p>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ‡®ğŸ‡·</div>
          <div>
            <h3 class="kpi-title">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ (ØªÙˆÙ…Ø§Ù†)</h3>
          </div>
        </div>
        <div class="kpi-value" id="current_toman_value_detail">...</div>
        <p class="kpi-subtitle">Ù†Ø±Ø®: {{ '{:,.0f}'.format(usd_to_toman) }} ØªÙˆÙ…Ø§Ù†</p>
      </div>
    </div>
  </div>

  <!-- Performance -->
  <div class="kpi-section">
    <h2 class="kpi-section-title">ğŸ“Š Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h2>
    <div class="kpi-grid">
      <div class="kpi-card {% if profit_loss_usd >= 0 %}positive{% else %}negative{% endif %}">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“Š</div>
          <div>
            <h3 class="kpi-title">Ø³ÙˆØ¯ / Ø²ÛŒØ§Ù†</h3>
          </div>
        </div>
        <div class="kpi-value" id="profit_loss_value_detail">${{ '%.2f' % profit_loss_usd }}</div>
        <p class="kpi-subtitle" id="profit_loss_toman_detail">{{ '{:,.0f}'.format(profit_loss_usd * usd_to_toman) }} ØªÙˆÙ…Ø§Ù†</p>
      </div>
      
      <div class="kpi-card {% if roi_percentage >= 0 %}positive{% else %}negative{% endif %}">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“ˆ</div>
          <div>
            <h3 class="kpi-title">Ø¨Ø§Ø²Ø¯Ù‡ (ROI)</h3>
          </div>
        </div>
        <div class="kpi-value" id="roi_value_detail">{{ '%.1f' % roi_percentage }}%</div>
        <p class="kpi-subtitle">Ù†Ø³Ø¨Øª Ø¨Ù‡ Ø³Ø±Ù…Ø§ÛŒÙ‡ Ø®Ø§Ù„Øµ</p>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">â°</div>
          <div>
            <h3 class="kpi-title">Ù…Ø¯Øª Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3>
          </div>
        </div>
        <div class="kpi-value">{{ inception_days }} <span style="font-size: 16px; color: var(--muted);">Ø±ÙˆØ²</span></div>
        <p class="kpi-subtitle">Ø§Ø² Ø´Ø±ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª</p>
      </div>
    </div>
  </div>

  <!-- Transaction Details -->
  <div class="kpi-section">
    <h2 class="kpi-section-title">ğŸ’° Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h2>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“ˆ</div>
          <div>
            <h3 class="kpi-title">Ú©Ù„ Ø®Ø±ÛŒØ¯ (USD)</h3>
          </div>
        </div>
        <div class="kpi-value">${{ '%.2f' % total_invested_usd }}</div>
        <p class="kpi-subtitle">{{ total_purchases_count }} ØªØ±Ø§Ú©Ù†Ø´</p>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ“‰</div>
          <div>
            <h3 class="kpi-title">Ú©Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª (USD)</h3>
          </div>
        </div>
        <div class="kpi-value">${{ '%.2f' % total_withdrawn_usd }}</div>
        <p class="kpi-subtitle">{{ total_withdrawals_count }} ØªØ±Ø§Ú©Ù†Ø´</p>
      </div>
      
      <div class="kpi-card">
        <div class="kpi-header">
          <div class="kpi-icon">ğŸ’°</div>
          <div>
            <h3 class="kpi-title">Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®Ø§Ù„Øµ</h3>
          </div>
        </div>
        <div class="kpi-value">${{ '%.2f' % net_invested_usd }}</div>
        <p class="kpi-subtitle">Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´: {{ last_transaction_date or 'Ù‡ÛŒÚ†' }}</p>
      </div>
    </div>
  </div>

  <!-- Info Card -->
  <div class="info-card">
    <div class="info-icon">ğŸ’¡</div>
    <p class="info-text">Ù‚ÛŒÙ…Øª ÙØ¹Ù„ÛŒ BTC Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² Ø¨Ø§Ø²Ø§Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯</p>
  </div>

  <!-- Trades Section -->
  <div class="kpi-section">
    <h2 class="kpi-section-title">ğŸ“ˆ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h2>
    
    <!-- Desktop Trades -->
    <div id="trades_desktop">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <div>
          <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: var(--text);">ğŸŸ¢ Ø¨Ø§Ø²</h3>
          <div class="table-scroll">
            <table class="responsive">
              <thead>
                <tr>
                  <th>Ø´Ù†Ø§Ø³Ù‡</th>
                  <th>ØªØ§Ø±ÛŒØ®</th>
                  <th>BTC Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
                  <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª (USD)</th>
                  <th>Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ</th>
                  <th>Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</th>
                </tr>
              </thead>
              <tbody id="open_trades_body">
              </tbody>
            </table>
          </div>
        </div>
        
        <div>
          <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: var(--text);">ğŸ”´ Ø¨Ø³ØªÙ‡</h3>
          <div class="table-scroll">
            <table class="responsive">
              <thead>
                <tr>
                  <th>Ø´Ù†Ø§Ø³Ù‡</th>
                  <th>Ø®Ø±ÛŒØ¯</th>
                  <th>Ø®Ø±ÙˆØ¬</th>
                  <th>BTC</th>
                  <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯</th>
                  <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÙˆØ¬</th>
                  <th>Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†</th>
                </tr>
              </thead>
              <tbody id="closed_trades_body">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile Trades -->
    <div id="trades_mobile" style="display:none;">
      <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: var(--text);">ğŸŸ¢ Ø¨Ø§Ø²</h3>
      <div id="open_cards" class="row"></div>
      <div class="divider"></div>
      <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: var(--text);">ğŸ”´ Ø¨Ø³ØªÙ‡</h3>
      <div id="closed_cards" class="row"></div>
    </div>
  </div>

<script>
(function() {
  const btcAmount = {{ current_btc_balance }};
  let usdToToman = {{ usd_to_toman }};  // Initial from server
  const netInvestedUsd = {{ net_invested_usd }};
  
  // Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
  function fetchCurrentPrice() {
    return fetch('/api/price')
      .then(response => response.json())
      .then(data => {
        usdToToman = data.usdt_irt || usdToToman;  // Update toman rate
        return data.btc_usdt;
      })
      .catch(() => 50000);
  }
  
  function updateValues(currentPrice) {
    const usdValue = btcAmount * currentPrice;
    const tomanValue = usdValue * usdToToman;
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ø¯Ø± header
    document.getElementById('current_usd_value').textContent = '$' + usdValue.toFixed(2);
    document.getElementById('current_toman_value').textContent = tomanValue.toLocaleString('fa-IR');
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ Ø¯Ø± detail sections
    document.getElementById('current_usd_value_detail').textContent = '$' + usdValue.toFixed(2);
    document.getElementById('current_toman_value_detail').textContent = tomanValue.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø¨Ø§ Ø¯Ø± Ù†Ø¸Ø± Ú¯ÛŒØ±ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø³ØªÙ‡ Ùˆ Ø¨Ø§Ø²
    const purchases = {{ purchases|tojson }};
    const withdrawals = {{ withdrawals|tojson }};
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø³ØªÙ‡ Ø¨Ø§ FIFO
    let closedTradesProfit = 0;
    let purchaseQueue = purchases.map(p => ({
      id: p.id,
      date: p.created_at,
      amount: parseFloat(p.amount_btc),
      price: parseFloat(p.price_usd_per_btc)
    })).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    let withdrawalQueue = withdrawals.map(w => ({
      id: w.id,
      date: w.created_at,
      amount: parseFloat(w.amount_btc),
      price: parseFloat(w.price_usd_per_btc)
    })).sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø³ØªÙ‡
    for (let withdrawal of withdrawalQueue) {
      let remainingWithdrawal = withdrawal.amount;
      
      while (remainingWithdrawal > 1e-12 && purchaseQueue.length > 0) {
        let purchase = purchaseQueue[0];
        let tradeAmount = Math.min(remainingWithdrawal, purchase.amount);
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù† Ø§ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡
        let buyCost = tradeAmount * purchase.price;
        let sellValue = tradeAmount * withdrawal.price;
        let tradeProfit = sellValue - buyCost;
        closedTradesProfit += tradeProfit;
        
        // Ú©Ø§Ù‡Ø´ Ø§Ø² ØµÙâ€ŒÙ‡Ø§
        remainingWithdrawal -= tradeAmount;
        purchase.amount -= tradeAmount;
        
        // Ø§Ú¯Ø± Ø®Ø±ÛŒØ¯ ØªÙ…Ø§Ù… Ø´Ø¯ØŒ Ø§Ø² ØµÙ Ø­Ø°Ù Ú©Ù†
        if (purchase.amount <= 1e-12) {
          purchaseQueue.shift();
        }
      }
    }
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø§Ø²
    let openTradesValue = 0;
    let openTradesCost = 0;
    for (let purchase of purchaseQueue) {
      openTradesCost += purchase.amount * purchase.price;
      openTradesValue += purchase.amount * currentPrice;
    }
    
    let openTradesProfit = openTradesValue - openTradesCost;
    let totalProfitLoss = closedTradesProfit + openTradesProfit;
    let profitLossToman = totalProfitLoss * usdToToman;
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
    document.getElementById('profit_loss_value').textContent = '$' + totalProfitLoss.toFixed(2);
    document.getElementById('profit_loss_value_detail').textContent = '$' + totalProfitLoss.toFixed(2);
    document.getElementById('profit_loss_toman_detail').textContent = profitLossToman.toLocaleString('fa-IR') + ' ØªÙˆÙ…Ø§Ù†';
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ROI
    let roiPercentage = 0;
    if (netInvestedUsd > 0) {
      roiPercentage = (totalProfitLoss / netInvestedUsd) * 100;
    }
    document.getElementById('roi_value_detail').textContent = roiPercentage.toFixed(1) + '%';
    
    // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ KPI Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†
    const profitLossCards = document.querySelectorAll('.kpi-card.positive, .kpi-card.negative');
    profitLossCards.forEach(card => {
      card.classList.remove('positive', 'negative');
      card.classList.add(totalProfitLoss >= 0 ? 'positive' : 'negative');
    });
    
    // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ header cards
    const headerCards = document.querySelectorAll('.balance-card');
    if (headerCards.length >= 4) {
      headerCards[3].style.color = totalProfitLoss >= 0 ? '#10b981' : '#ef4444';
    }
  }
  
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
  fetchCurrentPrice().then(updateValues);
  
  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
  setInterval(() => {
    fetchCurrentPrice().then(updateValues);
  }, 30000);
})();
</script>

<script>
  (function(){
    var purchases = {{ purchases|tojson }};
    var withdrawals = {{ withdrawals|tojson }};
    var openBody = document.getElementById('open_trades_body');
    var closedBody = document.getElementById('closed_trades_body');
    var usdToToman = {{ usd_to_toman }};
    var priceEl = document.getElementById('btc_usd');

    function toNum(x){ return typeof x === 'number' ? x : Number(x); }

    // FIFO match
    var queue = purchases.map(function(p){
      return { id:p.id, date:p.created_at, amount: toNum(p.amount_btc), price: toNum(p.price_usd_per_btc) };
    }).reverse(); // oldest first
    var closedLots = [];
    withdrawals.slice().forEach(function(w){
      var remain = toNum(w.amount_btc);
      var wPrice = toNum(w.price_usd_per_btc);
      while(remain > 1e-12 && queue.length){
        var lot = queue[0];
        var take = Math.min(remain, lot.amount);
        // record closed trade row
        var buyCost = take * lot.price;
        var sellVal = take * wPrice;
        var pl = sellVal - buyCost;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td data-label="#">'+lot.id+'</td>'+
                       '<td data-label="Ø®Ø±ÛŒØ¯">'+lot.date+'</td>'+
                       '<td data-label="Ø®Ø±ÙˆØ¬">'+w.created_at+'</td>'+
                       '<td data-label="BTC">'+take.toFixed(8)+'</td>'+
                       '<td data-label="Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯">'+lot.price.toFixed(2)+'</td>'+
                       '<td data-label="Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÙˆØ¬">'+wPrice.toFixed(2)+'</td>'+
                       '<td data-label="Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†">'+pl.toFixed(2)+' $</td>';
        closedBody.appendChild(tr);
        closedLots.push({ id: lot.id, buy: lot.date, sell: w.created_at, btc: take, buyP: lot.price, sellP: wPrice, pl: pl });
        lot.amount -= take;
        remain -= take;
        if(lot.amount <= 1e-12) queue.shift();
      }
    });

    function renderOpen(currentPrice){
      openBody.innerHTML='';
      var openCards = document.getElementById('open_cards');
      if (openCards) openCards.innerHTML='';
      queue.forEach(function(lot){
        var cost = lot.amount * lot.price;
        var curVal = lot.amount * currentPrice;
        var pl = curVal - cost;
        var tr = document.createElement('tr');
        tr.innerHTML = '<td data-label="#">'+lot.id+'</td>'+
                       '<td data-label="ØªØ§Ø±ÛŒØ®">'+lot.date+'</td>'+
                       '<td data-label="BTC Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡">'+lot.amount.toFixed(8)+'</td>'+
                       '<td data-label="Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù‚ÛŒÙ…Øª (USD)">'+lot.price.toFixed(2)+'</td>'+
                       '<td data-label="Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ">'+curVal.toFixed(2)+' $</td>'+
                       '<td data-label="Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†">'+pl.toFixed(2)+' $</td>';
        openBody.appendChild(tr);
        if (openCards) {
          var cost = lot.amount * lot.price;
          var curVal = lot.amount * currentPrice;
          var pl = curVal - cost;
          var card = document.createElement('div');
          card.className = 'card col';
          card.innerHTML = '<div class="kpi">'+
            '<div class="icon">ğŸ“ˆ</div>'+
            '<div>'+
            '<div class="label">#'+lot.id+' â€¢ '+lot.date+'</div>'+
            '<div class="value">'+lot.amount.toFixed(8)+' <span class="sub">BTC</span></div>'+
            '<div class="sub">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: '+lot.price.toFixed(2)+' $</div>'+
            '<div class="label" style="margin-top:8px;">Ø§Ø±Ø²Ø´ ÙØ¹Ù„ÛŒ: '+curVal.toFixed(2)+' $ â€¢ Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†: '+pl.toFixed(2)+' $</div>'+
            '</div></div>';
          openCards.appendChild(card);
        }
      });
    }

    function renderClosedCards(){
      var closedCards = document.getElementById('closed_cards');
      if (!closedCards) return;
      closedCards.innerHTML = '';
      closedLots.forEach(function(r){
        var card = document.createElement('div');
        card.className = 'card col';
        card.innerHTML = '<div class="kpi">'+
          '<div class="icon">ğŸ“‰</div>'+
          '<div>'+
          '<div class="label">#'+r.id+' â€¢ '+r.buy+' â†’ '+r.sell+'</div>'+
          '<div class="value">'+r.btc.toFixed(8)+' <span class="sub">BTC</span></div>'+
          '<div class="sub">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÛŒØ¯: '+r.buyP.toFixed(2)+' $ â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø®Ø±ÙˆØ¬: '+r.sellP.toFixed(2)+' $</div>'+
          '<div class="label" style="margin-top:8px;">Ø³ÙˆØ¯/Ø²ÛŒØ§Ù†: '+r.pl.toFixed(2)+' $</div>'+
          '</div></div>';
        closedCards.appendChild(card);
      });
    }
    renderClosedCards();

    function readPrice(){
      var p = Number(priceEl && priceEl.textContent && priceEl.textContent.replace(/[^0-9.]/g,''));
      if (!isFinite(p) || p<=0) return null;
      return p;
    }

    var initial = readPrice();
    if (initial) renderOpen(initial);
    var obs = new MutationObserver(function(){
      var p = readPrice();
      if (p) renderOpen(p);
    });
    if (priceEl) obs.observe(priceEl, { childList:true });

    function applyResponsive(){
      var isMobile = window.matchMedia('(max-width: 640px)').matches;
      var d = document.getElementById('trades_desktop');
      var m = document.getElementById('trades_mobile');
      if (d && m) {
        d.style.display = isMobile ? 'none' : '';
        m.style.display = isMobile ? '' : 'none';
      }
    }
    applyResponsive();
    window.addEventListener('resize', applyResponsive);
  })();
</script>
{% endblock %}
