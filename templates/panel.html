{% extends "base.html" %}

{% block title %}داشبورد{% endblock %}

{% block content %}
  <style>
    /* Enhanced Dashboard Styles */
    .dashboard-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 24px;
      padding: 32px;
      margin-bottom: 24px;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }
    
    .hero-content {
      position: relative;
      z-index: 1;
    }
    
    .hero-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .hero-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin: 0 0 24px 0;
    }
    
    .hero-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
    }
    
    .hero-stat {
      text-align: center;
      padding: 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .hero-stat-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .hero-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Enhanced KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    
    @media (min-width: 640px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (min-width: 1024px) {
      .kpi-grid { grid-template-columns: repeat(4, 1fr); }
    }
    
    .kpi-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .kpi-card:hover::before {
      transform: scaleX(1);
    }
    
    .kpi-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .kpi-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      margin: 0;
    }
    
    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text);
      margin: 0 0 8px 0;
      line-height: 1;
    }
    
    .kpi-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .kpi-trend.positive {
      color: #10b981;
    }
    
    .kpi-trend.negative {
      color: #ef4444;
    }
    
    .kpi-trend-icon {
      font-size: 14px;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .action-card {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 20px;
      text-decoration: none;
      color: inherit;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    
    .action-card:hover::before {
      opacity: 1;
    }
    
    .action-content {
      position: relative;
      z-index: 1;
    }
    
    .action-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: var(--pill-bg);
      margin-bottom: 12px;
    }
    
    .action-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 4px 0;
    }
    
    .action-description {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }
    
    /* Performance Chart Placeholder */
    .chart-container {
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .chart-placeholder {
      height: 200px;
      background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 16px;
      position: relative;
      overflow: hidden;
    }
    
    .chart-placeholder::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="chartPattern" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 0,20 L 20,0 M -1,1 L 1,-1 M 19,21 L 21,19" stroke="%23e2e8f0" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23chartPattern)"/></svg>');
      opacity: 0.5;
    }
    
    /* Responsive Design */
    @media (max-width: 640px) {
      .dashboard-hero {
        padding: 24px 20px;
        margin-bottom: 16px;
      }
      
      .hero-title {
        font-size: 24px;
      }
      
      .hero-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      .hero-stat {
        padding: 12px;
      }
      
      .hero-stat-value {
        font-size: 20px;
      }
      
      .kpi-card {
        padding: 20px;
      }
      
      .kpi-value {
        font-size: 28px;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
    }
    
    /* Animation for loading states */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loading {
      animation: pulse 2s infinite;
    }
    
    /* Enhanced hover effects */
    .kpi-card, .action-card {
      cursor: pointer;
    }
    
    .kpi-card:active, .action-card:active {
      transform: translateY(0);
    }
  </style>

  <!-- Hero Section -->
  <div class="dashboard-hero">
    <div class="hero-content">
      <h1 class="hero-title">خوش آمدید به داشبورد سرمایه‌گذاری</h1>
      <p class="hero-subtitle">مدیریت هوشمند سرمایه‌گذاری بیت‌کوین شما</p>
      
      <div class="hero-stats">
        <div class="hero-stat">
          <div class="hero-stat-value" id="hero_btc">{{ '%.8f' % current_btc_balance }}</div>
          <div class="hero-stat-label">موجودی BTC</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-value" id="hero_usd">...</div>
          <div class="hero-stat-label">ارزش USD</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-value" id="hero_toman">...</div>
          <div class="hero-stat-label">ارزش تومان</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-value" id="hero_roi">{{ '%.1f' % roi_percentage }}%</div>
          <div class="hero-stat-label">بازده کل</div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <a class="kpi-card" href="{{ url_for('panel_bp.deposits_page') }}" style="text-decoration:none; color: inherit;">
      <div class="kpi-header">
        <div class="kpi-icon">💰</div>
        <div>
          <h3 class="kpi-title">واریزی کل</h3>
        </div>
      </div>
      <div class="kpi-value">${{ '%.2f' % total_purchased_usd }}</div>
      <p class="kpi-subtitle">{{ '{:,.0f}'.format(total_purchased_usd * usd_to_toman) }} تومان</p>
      <div class="kpi-trend positive">
        <span class="kpi-trend-icon">📈</span>
        <span>سرمایه‌گذاری شده</span>
      </div>
    </a>

    <a class="kpi-card" href="{{ url_for('panel_bp.withdrawals_page') }}" style="text-decoration:none; color: inherit;">
      <div class="kpi-header">
        <div class="kpi-icon">💸</div>
        <div>
          <h3 class="kpi-title">برداشت کل</h3>
        </div>
      </div>
      <div class="kpi-value">${{ '%.2f' % total_withdrawn_usd }}</div>
      <p class="kpi-subtitle">{{ '{:,.0f}'.format(total_withdrawn_usd * usd_to_toman) }} تومان</p>
      <div class="kpi-trend negative">
        <span class="kpi-trend-icon">📉</span>
        <span>خروج از سرمایه</span>
      </div>
    </a>

    <a class="kpi-card" href="{{ url_for('panel_bp.balance_page') }}" style="text-decoration:none; color: inherit;">
      <div class="kpi-header">
        <div class="kpi-icon">💎</div>
        <div>
          <h3 class="kpi-title">موجودی فعلی</h3>
        </div>
      </div>
      <div class="kpi-value" id="hold_btc">{{ '%.8f' % current_btc_balance }} <span style="font-size: 16px; color: var(--muted);">BTC</span></div>
      <p class="kpi-subtitle" id="hold_usd">...</p>
      <div class="kpi-trend positive">
        <span class="kpi-trend-icon">💎</span>
        <span>دارایی فعلی</span>
      </div>
    </a>

    <a class="kpi-card" href="{{ url_for('panel_bp.balance_page') }}" style="text-decoration:none; color: inherit;">
      <div class="kpi-header">
        <div class="kpi-icon">📊</div>
        <div>
          <h3 class="kpi-title">سود / زیان</h3>
        </div>
      </div>
      <div class="kpi-value" id="pl_usd">...</div>
      <p class="kpi-subtitle" id="pl_tmn"></p>
      <div class="kpi-trend" id="pl_trend">
        <span class="kpi-trend-icon" id="pl_icon">📈</span>
        <span id="pl_text">محاسبه...</span>
      </div>
    </a>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <a href="{{ url_for('panel_bp.deposits_page') }}" class="action-card">
      <div class="action-content">
        <div class="action-icon">💰</div>
        <h3 class="action-title">واریزی جدید</h3>
        <p class="action-description">ثبت خرید بیت‌کوین جدید</p>
      </div>
    </a>

    <a href="{{ url_for('panel_bp.withdrawals_page') }}" class="action-card">
      <div class="action-content">
        <div class="action-icon">💸</div>
        <h3 class="action-title">برداشت</h3>
        <p class="action-description">ثبت فروش بیت‌کوین</p>
      </div>
    </a>

    <a href="{{ url_for('panel_bp.balance_page') }}" class="action-card">
      <div class="action-content">
        <div class="action-icon">📈</div>
        <h3 class="action-title">تحلیل عملکرد</h3>
        <p class="action-description">مشاهده معاملات و آمار</p>
      </div>
    </a>

    <a href="{{ url_for('panel_bp.settings_page') }}" class="action-card">
      <div class="action-content">
        <div class="action-icon">⚙️</div>
        <h3 class="action-title">تنظیمات</h3>
        <p class="action-description">مدیریت حساب و تنظیمات</p>
      </div>
    </a>
  </div>

  <!-- Performance Chart Placeholder -->
  <div class="chart-container">
    <div class="chart-header">
      <h3 class="chart-title">نمودار عملکرد</h3>
    </div>
    <div class="chart-placeholder">
      <div>نمودار عملکرد سرمایه‌گذاری</div>
    </div>
  </div>
    
    
    
  
  <script>
    (function () {
      let usdToToman = Number("{{ '%.0f' % usd_to_toman }}");  // Initial
      var usdEl = document.getElementById('btc_usd');
      var tomanEl = document.getElementById('btc_toman');
      var currentBtcBalance = Number("{{ '%.8f' % current_btc_balance }}");
      var netInvestedUsd = Number("{{ '%.2f' % net_invested_usd }}");
      var inceptionDays = Number("{{ inception_days }}");

      // New dashboard elements
      var heroUsdEl = document.getElementById('hero_usd');
      var heroTomanEl = document.getElementById('hero_toman');
      var heroRoiEl = document.getElementById('hero_roi');
      var holdUsdEl = document.getElementById('hold_usd');
      var plUsdEl = document.getElementById('pl_usd');
      var plTmnEl = document.getElementById('pl_tmn');
      var plTrendEl = document.getElementById('pl_trend');
      var plIconEl = document.getElementById('pl_icon');
      var plTextEl = document.getElementById('pl_text');


      async function fetchPrice() {
        try {
          var res = await fetch('/api/price', { cache: 'no-store' });
          if (!res.ok) throw new Error('bad status');
          var data = await res.json();
          usdToToman = Number(data.usdt_irt) || usdToToman;
          var price = Number(data.btc_usdt);
          if (!isFinite(price)) throw new Error('bad price');
          
          // Update header price
          if (usdEl) usdEl.textContent = price.toFixed(2);
          if (tomanEl) {
            var toman = Math.round(price * usdToToman);
            tomanEl.textContent = '(' + toman.toLocaleString('fa-IR') + ' تومان)';
          }
          
          // Calculate current values
          var holdUsd = currentBtcBalance * price;
          var holdTmn = Math.round(holdUsd * usdToToman);
          
          // Update hero section
          if (heroUsdEl) heroUsdEl.textContent = '$' + holdUsd.toFixed(2);
          if (heroTomanEl) heroTomanEl.textContent = holdTmn.toLocaleString('fa-IR');
          
          // Update KPI cards
          if (holdUsdEl) holdUsdEl.textContent = '$' + holdUsd.toFixed(2) + ' (' + holdTmn.toLocaleString('fa-IR') + ' تومان)';
          
          // محاسبه دقیق سود/زیان با در نظر گیری معاملات بسته و باز
          // اینجا باید داده‌های purchases و withdrawals از سرور دریافت شوند
          // برای حالا از محاسبه ساده استفاده می‌کنیم
          var plUsd = holdUsd - netInvestedUsd;
          var plTmn = Math.round(plUsd * usdToToman);
          
          if (plUsdEl) {
            plUsdEl.textContent = '$' + plUsd.toFixed(2);
            plUsdEl.style.color = plUsd >= 0 ? '#10b981' : '#ef4444';
          }
          
          if (plTmnEl) {
            plTmnEl.textContent = plTmn.toLocaleString('fa-IR') + ' تومان';
            plTmnEl.style.color = plUsd >= 0 ? '#10b981' : '#ef4444';
          }
          
          // Update P/L trend
          if (plTrendEl) {
            plTrendEl.className = 'kpi-trend ' + (plUsd >= 0 ? 'positive' : 'negative');
            if (plIconEl) plIconEl.textContent = plUsd >= 0 ? '📈' : '📉';
            if (plTextEl) plTextEl.textContent = plUsd >= 0 ? 'سود' : 'زیان';
          }
          
          // Calculate ROI
          var roi = 0;
          if (netInvestedUsd > 0) {
            roi = (plUsd / netInvestedUsd) * 100;
          }
          
          if (heroRoiEl) {
            heroRoiEl.textContent = roi.toFixed(1) + '%';
            heroRoiEl.style.color = roi >= 0 ? '#10b981' : '#ef4444';
          }
          
        } catch (e) {
          console.error('Price fetch error:', e);
          if (usdEl) usdEl.textContent = '—';
          if (tomanEl) tomanEl.textContent = '';
          if (heroUsdEl) heroUsdEl.textContent = '—';
          if (heroTomanEl) heroTomanEl.textContent = '—';
          if (holdUsdEl) holdUsdEl.textContent = '—';
          if (plUsdEl) plUsdEl.textContent = '—';
          if (plTmnEl) plTmnEl.textContent = '';
        }
      }
      
      // Initial load
      fetchPrice();
      
      // Update every 30 seconds
      setInterval(fetchPrice, 30000);

      // Auto-hide flashes after 3 seconds
      var fb = document.getElementById('flashBox');
      if (fb) {
        setTimeout(function () {
          var items = fb.querySelectorAll('.flash');
          items.forEach(function (el) { el.classList.add('hide'); });
          setTimeout(function () { fb.remove(); }, 400);
        }, 3000);
      }

      // Add loading animation to elements that will be updated
      var loadingElements = [heroUsdEl, heroTomanEl, holdUsdEl, plUsdEl, plTmnEl];
      loadingElements.forEach(function(el) {
        if (el) el.classList.add('loading');
      });
      
      // Remove loading animation after first update
      setTimeout(function() {
        loadingElements.forEach(function(el) {
          if (el) el.classList.remove('loading');
        });
      }, 2000);

    })();
  </script>
{% endblock %}
