{% extends "base.html" %}

{% block title %}Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯{% endblock %}

{% block content %}
<div class="card" id="withdraw">
  <h2>Ø¨Ø±Ø¯Ø§Ø´Øª</h2>
  <div class="totals">
    <div class="pill">Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ù„ (USD): <strong>{{ '%.2f' % total_withdraw_usd }}</strong> $</div>
    <div class="pill">Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ù„ (ØªÙˆÙ…Ø§Ù†): <strong>{{ '{:,.0f}'.format(total_withdraw_toman) }}</strong></div>
    <div class="pill">Ø¨Ø±Ø¯Ø§Ø´Øª BTC: <strong>{{ '%.8f' % total_withdraw_btc }}</strong> BTC</div>
  </div>
  <form method="post" action="{{ url_for('panel_bp.panel_withdraw') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="form-grid">
      <label>
        Ù…Ù‚Ø¯Ø§Ø± BTC Ø¨Ø±Ø¯Ø§Ø´Øª
        <input type="number" step="0.00000001" min="0" name="amount_btc" required inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 0.003">
      </label>
      <label>
        Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± Ù‡Ø± BTC (Ù„Ø­Ø¸Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª)
        <input type="number" step="0.01" min="0" name="price_usd_per_btc" required inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ 60000">
      </label>
    </div>
    <div class="section-actions" style="margin-top:12px; display:flex; gap:10px;">
      <button type="submit" class="btn btn-danger">Ø«Ø¨Øª Ø¨Ø±Ø¯Ø§Ø´Øª</button>
    </div>
  </form>
</div>

<div class="card" id="withdrawals-list">
  <h2>Ù„ÛŒØ³Øª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h2>
  <div id="wd_desktop">
    <div class="table-scroll">
      <table class="responsive">
        <thead>
          <tr>
            <th>#</th>
            <th>ØªØ§Ø±ÛŒØ®</th>
            <th>BTC</th>
            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (USD)</th>
            <th>Ù…Ø¨Ù„Øº (USD)</th>
          </tr>
        </thead>
        <tbody>
          {% if withdrawals %}
            {% for w in withdrawals %}
              <tr>
                <td data-label="#">{{ w["id"] }}</td>
                <td class="muted" data-label="ØªØ§Ø±ÛŒØ®">{{ w["created_at"] }}</td>
                <td data-label="BTC">{{ '%.8f' % w["amount_btc"] }}</td>
                <td data-label="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (USD)">{{ '%.2f' % w["price_usd_per_btc"] }}</td>
                <td data-label="Ù…Ø¨Ù„Øº (USD)">{{ '%.2f' % (w["amount_btc"] * w["price_usd_per_btc"]) }}</td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="5" class="muted">Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  <div id="wd_mobile" style="display:none;">
    <div id="wd_cards" class="row"></div>
  </div>
</div>
<script>
  (function(){
    var isMobile = window.matchMedia('(max-width: 640px)');
    var d = document.getElementById('wd_desktop');
    var m = document.getElementById('wd_mobile');
    var cards = document.getElementById('wd_cards');
    var data = {{ withdrawals|tojson }};
    function renderCards(){
      if (!cards) return;
      cards.innerHTML = '';
      if (!data || !data.length){
        var empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
        cards.appendChild(empty);
        return;
      }
      data.forEach(function(w){
        var amt = Number(w.amount_btc || 0);
        var price = Number(w.price_usd_per_btc || 0);
        var total = amt * price;
        var card = document.createElement('div');
        card.className = 'card col';
        card.innerHTML = '<div class="kpi">'+
          '<div class="icon">ðŸ’¸</div>'+
          '<div>'+
          '<div class="label">#'+w.id+' â€¢ '+w.created_at+'</div>'+
          '<div class="value">'+amt.toFixed(8)+' <span class="sub">BTC</span></div>'+
          '<div class="label" style="margin-top:8px;">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: '+price.toFixed(2)+' $</div>'+
          '<div class="sub">Ù…Ø¨Ù„Øº: '+total.toFixed(2)+' $</div>'+
          '</div></div>';
        cards.appendChild(card);
      });
    }
    function apply(){
      var mobile = isMobile.matches;
      if (d) d.style.display = mobile ? 'none' : '';
      if (m) m.style.display = mobile ? '' : 'none';
      if (mobile) renderCards();
    }
    apply();
    isMobile.addEventListener('change', apply);
  })();
</script>
{% endblock %}
